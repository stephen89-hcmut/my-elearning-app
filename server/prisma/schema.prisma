// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS AND ROLES
// ============================================

enum UserRole {
  ADMIN
  INSTRUCTOR
  STUDENT
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum LectureStatus {
  NOTSTARTED
  INPROGRESS
  COMPLETED
}

enum TestResultStatus {
  INPROGRESS
  COMPLETED
}

enum CompletionStatus {
  INPROGRESS
  COMPLETED
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
}

model User {
  userId          Int       @id @default(autoincrement()) @map("user_id")
  username        String    @unique @db.VarChar(50)
  email           String    @unique @db.VarChar(255)
  firstName       String    @db.VarChar(50) @map("first_name")
  lastName        String    @db.VarChar(50) @map("last_name")
  password        String    @db.VarChar(100)
  role            UserRole  @default(STUDENT)
  bankName        String?   @db.VarChar(100) @map("bank_name")
  paymentAccount  String?   @db.VarChar(100) @map("payment_account")

  // Relations
  admin           Admin?
  instructor      Instructor?
  student         Student?

  @@map("USERS")
}

model Admin {
  adminId Int  @id @map("admin_id")
  user    User @relation(fields: [adminId], references: [userId], onDelete: Cascade)

  @@map("ADMINS")
}

model Instructor {
  instructorId Int    @id @map("instructor_id")
  teachingField String @db.VarChar(255) @map("teaching_field")
  bio          String? @db.Text

  user                 User                 @relation(fields: [instructorId], references: [userId], onDelete: Cascade)
  courseInstructors    CourseInstructor[]
  transactions         Transaction[]

  @@map("INSTRUCTORS")
}

model Student {
  studentId      Int    @id @map("student_id")
  enrollmentDate DateTime @default(now()) @map("enrollment_date") @db.Date

  user           User           @relation(fields: [studentId], references: [userId], onDelete: Cascade)
  enrollments    Enrollment[]
  testResults    TestResult[]
  courseRatings  CourseRating[]
  transactions   Transaction[]
  certificates   Certificate[]
  lectureViews   LectureView[]

  @@map("STUDENTS")
}

// ============================================
// COURSES AND TOPICS
// ============================================

model Topic {
  topicId     Int    @id @default(autoincrement()) @map("topic_id")
  topicName   String @unique @db.VarChar(100) @map("topic_name")
  description String? @db.Text

  courseTopics CourseTopics[]

  @@map("TOPICS")
}

model Course {
  courseId       Int    @id @default(autoincrement()) @map("course_id")
  courseName     String @unique @db.VarChar(255) @map("course_name")
  description    String? @db.Text
  language       String @db.VarChar(50)
  price          Decimal @default(0) @db.Decimal(10, 2)
  minScore       Int    @default(50) @map("min_score")
  level          CourseLevel @default(BEGINNER)
  totalLectures  Int    @default(0) @map("total_lectures")
  totalTests     Int    @default(0) @map("total_tests")
  totalDuration  Int    @default(0) @map("total_duration")

  // Relations
  sections           Section[]
  courseTopics       CourseTopics[]
  courseInstructors  CourseInstructor[]
  enrollments        Enrollment[]
  prerequisites      Prerequisite[] @relation("course")
  prerequisiteOf     Prerequisite[] @relation("prerequisite")
  transactions       Transaction[]
  courseRatings      CourseRating[]
  certificates       Certificate[]

  @@map("COURSES")
}

model CourseTopics {
  courseId Int @map("course_id")
  topicId  Int @map("topic_id")

  course Course @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  topic  Topic  @relation(fields: [topicId], references: [topicId], onDelete: Cascade)

  @@id([courseId, topicId])
  @@map("COURSE_TOPICS")
}

model CourseInstructor {
  courseId         Int     @map("course_id")
  instructorId     Int     @map("instructor_id")
  isMainInstructor Boolean @default(false) @map("is_main_instructor")

  course     Course      @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  instructor Instructor  @relation(fields: [instructorId], references: [instructorId], onDelete: Cascade)

  @@id([courseId, instructorId])
  @@map("COURSE_INSTRUCTORS")
}

model Prerequisite {
  courseId             Int @map("course_id")
  prerequisiteCourseId Int @map("prerequisite_course_id")

  course         Course @relation("course", fields: [courseId], references: [courseId], onDelete: Cascade)
  prerequisiteCourse Course @relation("prerequisite", fields: [prerequisiteCourseId], references: [courseId], onDelete: Cascade)

  @@id([courseId, prerequisiteCourseId])
  @@map("PREREQUISITES")
}

// ============================================
// SECTIONS AND LECTURES
// ============================================

model Section {
  sectionId      Int    @id @default(autoincrement()) @map("section_id")
  courseId       Int    @map("course_id")
  sectionName    String @db.VarChar(255) @map("section_name")
  sectionOrder   Int    @map("section_order")
  totalLectures  Int    @default(0) @map("total_lectures")
  totalTests     Int    @default(0) @map("total_tests")

  course  Course    @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  lectures Lecture[]
  tests   Test[]

  @@unique([courseId, sectionOrder])
  @@map("SECTIONS")
}

model Lecture {
  lectureId          Int     @id @default(autoincrement()) @map("lecture_id")
  sectionId          Int     @map("section_id")
  lectureName        String  @db.VarChar(255) @map("lecture_name")
  link               String  @db.VarChar(500)
  attachedMaterials  String? @db.VarChar(500) @map("attached_materials")
  durationMinutes    Int?    @map("duration_minutes")
  status             LectureStatus @default(NOTSTARTED)

  section     Section      @relation(fields: [sectionId], references: [sectionId], onDelete: Cascade)
  lectureViews LectureView[]

  @@map("LECTURES")
}

model LectureView {
  studentId Int
  lectureId Int
  status    LectureStatus @default(NOTSTARTED)
  viewDate  DateTime      @default(now()) @map("view_date")

  student Student @relation(fields: [studentId], references: [studentId], onDelete: Cascade)
  lecture Lecture @relation(fields: [lectureId], references: [lectureId], onDelete: Cascade)

  @@id([studentId, lectureId])
  @@map("LECTURE_VIEWS")
}

// ============================================
// TESTS AND QUESTIONS
// ============================================

model Test {
  testId          Int    @id @default(autoincrement()) @map("test_id")
  sectionId       Int    @map("section_id")
  testName        String @db.VarChar(255) @map("test_name")
  maxAttempts     Int    @default(1) @map("max_attempts")
  timeLimitMinutes Int   @map("time_limit_minutes")
  testUrl         String? @db.VarChar(500) @map("test_url")
  score           Int    @default(100)

  section    Section      @relation(fields: [sectionId], references: [sectionId], onDelete: Cascade)
  questions  Question[]
  testResults TestResult[]

  @@map("TESTS")
}

model Question {
  questionId  Int         @id @default(autoincrement()) @map("question_id")
  testId      Int         @map("test_id")
  content     String      @db.Text
  type        QuestionType
  correctAnswer String    @db.Text @map("correct_answer")

  test            Test             @relation(fields: [testId], references: [testId], onDelete: Cascade)
  questionChoices QuestionChoice[]

  @@map("QUESTIONS")
}

model QuestionChoice {
  choiceId    Int     @id @default(autoincrement()) @map("choice_id")
  questionId  Int     @map("question_id")
  wrongChoice String  @db.Text @map("wrong_choice")

  question Question @relation(fields: [questionId], references: [questionId], onDelete: Cascade)

  @@map("QUESTION_CHOICES")
}

model TestResult {
  resultId   Int     @id @default(autoincrement()) @map("result_id")
  studentId  Int     @map("student_id")
  testId     Int     @map("test_id")
  actualScore Decimal @default(0) @map("actual_score") @db.Decimal(5, 2)
  startTime  DateTime @map("start_time")
  submitTime DateTime? @map("submit_time")
  status     TestResultStatus @default(INPROGRESS)

  student Student @relation(fields: [studentId], references: [studentId], onDelete: Cascade)
  test    Test    @relation(fields: [testId], references: [testId], onDelete: Cascade)

  @@map("TEST_RESULTS")
}

// ============================================
// ENROLLMENTS AND TRANSACTIONS
// ============================================

model Enrollment {
  studentId        Int               @map("student_id")
  courseId         Int               @map("course_id")
  enrollmentDate   DateTime          @default(now()) @map("enrollment_date") @db.Date
  completionStatus CompletionStatus  @default(INPROGRESS) @map("completion_status")

  student Student @relation(fields: [studentId], references: [studentId], onDelete: Cascade)
  course  Course  @relation(fields: [courseId], references: [courseId], onDelete: Cascade)

  @@id([studentId, courseId])
  @@map("ENROLLMENTS")
}

model Transaction {
  transactionId  Int     @id @default(autoincrement()) @map("transaction_id")
  studentId      Int     @map("student_id")
  courseId       Int     @map("course_id")
  instructorId   Int     @map("instructor_id")
  price          Decimal @db.Decimal(10, 2)
  paymentStatus  PaymentStatus @map("payment_status")
  transactionDate DateTime @default(now()) @map("transaction_date")

  student    Student    @relation(fields: [studentId], references: [studentId], onDelete: Restrict)
  course     Course     @relation(fields: [courseId], references: [courseId], onDelete: Restrict)
  instructor Instructor @relation(fields: [instructorId], references: [instructorId], onDelete: Restrict)

  @@map("TRANSACTIONS")
}

// ============================================
// CERTIFICATES AND RATINGS
// ============================================

model Certificate {
  certificateId Int      @id @default(autoincrement()) @map("certificate_id")
  studentId     Int      @map("student_id")
  courseId      Int      @map("course_id")
  issuedDate    DateTime @default(now()) @map("issued_date") @db.Date

  student Student @relation(fields: [studentId], references: [studentId], onDelete: Restrict)
  course  Course  @relation(fields: [courseId], references: [courseId], onDelete: Restrict)

  @@unique([studentId, courseId])
  @@map("CERTIFICATES")
}

model CourseRating {
  studentId  Int      @map("student_id")
  courseId   Int      @map("course_id")
  rating     Int
  comment    String?  @db.Text
  ratingDate DateTime @default(now()) @map("rating_date")

  student Student @relation(fields: [studentId], references: [studentId], onDelete: Cascade)
  course  Course  @relation(fields: [courseId], references: [courseId], onDelete: Cascade)

  @@id([studentId, courseId])
  @@map("COURSE_RATINGS")
}
